<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Méta-tags pour forcer l'orientation portrait -->
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="msapplication-orientation" content="portrait">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>TiDash Game</title>
    <!-- Load Telegram WebApp script with defer to ensure it loads properly -->
    <script src="https://telegram.org/js/telegram-web-app.js" defer></script>
    
    <!-- Préchargement des sons -->
    <audio id="userTapSound" src="sounds/UserTap.mp3" preload="auto"></audio>
    <audio id="successSound" src="sounds/Success.mp3" preload="auto"></audio>
    <audio id="gameOverSound" src="sounds/Termine.mp3" preload="auto"></audio>
    <audio id="showScoreSound" src="sounds/Show_GameOver.mp3" preload="auto"></audio>
    <audio id="borderTouchSound" src="sounds/BorderTouch.mp3" preload="auto"></audio>
    <!-- Élément audio pour la musique de fond -->
    <audio id="backgroundMusic" preload="auto" loop></audio>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        body {
            font-family: 'Orbitron', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #0A0A0A; /* Noir presque pur */
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
            box-sizing: border-box;
        }
        
        .container {
            position: relative;
            width: 100%;
            height: 100vh;
            max-width: 500px;
            overflow: hidden;
            background-color: #121212; /* Gris très foncé */
            border: none;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }
        
        .preload-images {
            position: absolute;
            width: 0;
            height: 0;
            overflow: hidden;
            z-index: -1;
        }
        
        .user-profile {
            position: absolute;
            top: 20px;
            right: 20px;
            left: auto;
            display: flex;
            align-items: center;
            z-index: 10;
            flex-direction: row-reverse; /* Inverser l'ordre pour mettre l'avatar à droite */
        }
        
        .avatar-container {
            position: relative;
            width: 32px;
            height: 32px;
            margin-left: 6px;
            margin-right: 0;
        }
        
        .avatar-border {
            position: absolute;
            top: -1.5px;
            left: -1.5px;
            right: -1.5px;
            bottom: -1.5px;
            border: 2px solid #00FF9D;
            border-radius: 50%;
            box-sizing: border-box;
        }
        
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .user-info {
            color: white;
            text-align: right; /* Aligner le texte à droite */
        }
        
        .username {
            font-size: 11px;
            font-weight: bold;
            margin: 0;
            margin-bottom: 2px; /* Espacement entre username et ID */
        }
        
        .user-id {
            font-size: 9px;
            color: #aaa;
            margin: 0;
        }
        
        /* Styles pour la page de paramètres */
        #settings-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: none;
            z-index: 100;
        }
        
        .android-scroll-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        .settings-content {
            padding: 20px;
            box-sizing: border-box;
            color: white;
            padding-bottom: 100px; /* Espace supplémentaire en bas pour faciliter le défilement */
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .settings-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .close-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .close-icon {
            color: white;
            font-size: 20px;
        }
        
        .profile-card {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-avatar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #00FF9D;
            border-radius: 12px;
            box-sizing: border-box;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .username-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .username-input {
            background-color: transparent;
            border: none;
            color: white;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            padding: 5px 0;
            width: calc(100% - 30px);
            outline: none;
        }
        
        .edit-icon {
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 10px;
        }
        
        .user-id-display {
            font-size: 14px;
            color: #aaa;
        }
        
        .paypal-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            color: white;
            margin-bottom: 15px;
        }
        
        .paypal-input {
            width: 100%;
            background-color: rgba(30, 30, 30, 0.8);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            padding: 12px 15px;
            box-sizing: border-box;
            margin-bottom: 15px;
            outline: none;
        }
        
        .input-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .input-edit-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
        }
        
        .description-text {
            font-size: 12px;
            color: #aaa;
            line-height: 1.5;
        }
        
        .avatars-section {
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
            padding-bottom: 30px; /* Ajouter de l'espace en bas */
        }
        
        .avatars-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
            padding: 0 10px;
        }
        
        .avatar-item {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 auto;
        }
        
        .avatar-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-item.selected {
            border: 2px solid #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.8);
        }
        
        .avatar-check {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            opacity: 0;
        }
        
        .avatar-item.selected .avatar-check {
            opacity: 1;
        }
        
        /* Optimisation des images d'avatar */
        .preload-images {
            position: absolute;
            width: 0;
            height: 0;
            overflow: hidden;
            z-index: -1;
        }
        
        /* Styles pour le bouton de son */
        .sound-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s ease;
        }
        
        .sound-toggle:hover {
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }
        
        .sound-toggle svg {
            width: 24px;
            height: 24px;
        }
        
        .sound-toggle.muted .sound-on {
            display: none;
        }
        
        .sound-toggle:not(.muted) .sound-off {
            display: none;
        }
        
        /* Correction pour iOS */
        .avatars-wrapper {
            position: relative;
            padding-bottom: 60px; /* Espace supplémentaire en bas */
        }
        
        .ios-spacer {
            height: 60px; /* Espace supplémentaire pour éviter la zone noire */
            width: 100%;
        }
        
        /* Styles spécifiques pour les appareils Android */
        .android-device {
            -webkit-tap-highlight-color: transparent; /* Désactiver le surlignage au toucher sur Android */
        }
    </style>
</head>
<body>
    <div class="preload-images" id="preload-container"></div>
    <div class="container">
        <!-- Profil utilisateur -->
        <div class="user-profile" id="profile-button">
            <div class="avatar-container">
                <div class="avatar-border"></div>
                <img id="avatarImg" class="avatar-img" src="avatars/avatar_default.jpg" alt="Avatar">
            </div>
            <div class="user-info">
                <p id="username" class="username">Username</p>
                <p id="userId" class="user-id">0000000000</p>
            </div>
        </div>
        
        <canvas id="game-canvas"></canvas>
        
        <div id="home-screen">
            <div id="game-title-container">
                <div id="game-title">TiDash</div>
            </div>
            <div id="game-button-container">
                <button id="play-button" class="game-button">Tap to Start</button>
            </div>
            
            <!-- Bouton pour activer/désactiver le son -->
            <div id="sound-toggle" class="sound-toggle muted">
                <svg class="sound-on" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14.5 8.5C14.5 8.5 16 9.57 16 12C16 14.43 14.5 15.5 14.5 15.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18 5C18 5 21 7 21 12C21 17 18 19 18 19" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 10.5V13.5C3 14.6046 3.5 15.5 5 15.5C6.5 15.5 7 14.6046 7 13.5V10.5C7 9.39543 6.5 8.5 5 8.5C3.5 8.5 3 9.39543 3 10.5Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 10L11 7V17L7 14" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg class="sound-off" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 9L22 21" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M11 7L7 10H5C3.5 10 3 10.8954 3 12V12C3 13.1046 3.5 14 5 14H7L11 17V7Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14.5 10.5C14.5 10.5 15.0049 10.7705 15.5 11.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18 8C18 8 19.5 9.5 19.5 12" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
        </div>
        <div id="game-over">
            <div id="score-display">0</div>
            <div id="best-score">Best: 0</div>
            <div id="season-score" style="font-size: 2.2rem; color: #00FF9D; font-weight: bold; margin-bottom: 20px;">Season Best: 0</div>
            <div class="button-container">
                <button id="play-again" class="game-button">PLAY AGAIN</button>
                <button id="home-button" class="game-button secondary">HOME</button>
            </div>
        </div>
        
        <!-- Page de paramètres -->
        <div id="settings-screen">
            <div class="android-scroll-container">
                <div class="settings-content">
                    <div class="settings-header">
                        <div class="settings-title">Settings</div>
                        <div class="close-button" id="close-settings">
                            <span class="close-icon">✕</span>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <div class="profile-avatar">
                            <img id="settings-avatar" src="avatars/avatar_default.jpg" alt="Avatar">
                        </div>
                        <div class="profile-info">
                            <div class="username-container">
                                <input type="text" id="username-input" class="username-input" value="Username">
                                <div class="edit-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M16.4745 5.40768L18.5917 7.52483M17.8358 3.54254L11.6002 9.77806C11.3979 9.98031 11.2619 10.2384 11.2104 10.5192L10.5798 13.4209L13.4816 12.7903C13.7624 12.7388 14.0205 12.6028 14.2227 12.4006L20.4582 6.16508C20.5844 6.03889 20.6846 5.88909 20.7536 5.72343C20.8226 5.55777 20.8589 5.37966 20.8605 5.19938C20.8621 5.01909 20.8289 4.84039 20.7628 4.6736C20.6967 4.50681 20.5991 4.35537 20.4749 4.22718C20.3507 4.09899 20.2022 3.99691 20.0374 3.92553C19.8726 3.85415 19.6951 3.81549 19.5157 3.81169C19.3364 3.8079 19.1574 3.83906 18.9899 3.90281C18.8224 3.96656 18.6698 4.06188 18.5401 4.18348L12.3046 10.419C12.1023 10.6212 11.9664 10.8793 11.9149 11.1601L11.2843 14.0619L14.186 13.4313C14.4668 13.3798 14.7249 13.2438 14.9272 13.0416L21.1627 6.80608C21.8106 6.15818 22.1655 5.28206 22.1529 4.36728C22.1403 3.45249 21.7612 2.58647 21.0961 1.9549C20.431 1.32333 19.5401 0.96993 18.6146 1.00182C17.689 1.03372 16.8179 1.44959 16.1974 2.12483L9.96196 8.36035C9.35302 8.96929 8.94371 9.74882 8.79747 10.5981L7.7655 15.2322C7.73328 15.3697 7.73471 15.5131 7.76969 15.6498C7.80467 15.7864 7.87221 15.9122 7.96643 16.0172C8.06066 16.1222 8.17871 16.2034 8.31082 16.2544C8.44293 16.3054 8.58559 16.3247 8.72856 16.3108L13.3627 15.2788C14.212 15.1326 14.9915 14.7233 15.6004 14.1143L21.8359 7.87877L16.4745 5.40768Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="user-id-display">ID : <span id="settings-user-id">0000000000</span></div>
                    </div>
                </div>
                
                <div class="paypal-section">
                    <div class="section-title">Enter your PayPal email address</div>
                    <div class="input-container">
                        <input type="email" id="paypal-email" class="paypal-input" placeholder="mypaypal@email.com">
                        <div class="input-edit-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16.4745 5.40768L18.5917 7.52483M17.8358 3.54254L11.6002 9.77806C11.3979 9.98031 11.2619 10.2384 11.2104 10.5192L10.5798 13.4209L13.4816 12.7903C13.7624 12.7388 14.0205 12.6028 14.2227 12.4006L20.4582 6.16508C20.5844 6.03889 20.6846 5.88909 20.7536 5.72343C20.8226 5.55777 20.8589 5.37966 20.8605 5.19938C20.8621 5.01909 20.8289 4.84039 20.7628 4.6736C20.6967 4.50681 20.5991 4.35537 20.4749 4.22718C20.3507 4.09899 20.2022 3.99691 20.0374 3.92553C19.8726 3.85415 19.6951 3.81549 19.5157 3.81169C19.3364 3.8079 19.1574 3.83906 18.9899 3.90281C18.8224 3.96656 18.6698 4.06188 18.5401 4.18348L12.3046 10.419C12.1023 10.6212 11.9664 10.8793 11.9149 11.1601L11.2843 14.0619L14.186 13.4313C14.4668 13.3798 14.7249 13.2438 14.9272 13.0416L21.1627 6.80608C21.8106 6.15818 22.1655 5.28206 22.1529 4.36728C22.1403 3.45249 21.7612 2.58647 21.0961 1.9549C20.431 1.32333 19.5401 0.96993 18.6146 1.00182C17.689 1.03372 16.8179 1.44959 16.1974 2.12483L9.96196 8.36035C9.35302 8.96929 8.94371 9.74882 8.79747 10.5981L7.7655 15.2322C7.73328 15.3697 7.73471 15.5131 7.76969 15.6498C7.80467 15.7864 7.87221 15.9122 7.96643 16.0172C8.06066 16.1222 8.17871 16.2034 8.31082 16.2544C8.44293 16.3054 8.58559 16.3247 8.72856 16.3108L13.3627 15.2788C14.212 15.1326 14.9915 14.7233 15.6004 14.1143L21.8359 7.87877L16.4745 5.40768Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                    <div class="description-text">
                        This is where your prize money will be sent if you win 1st place in the season ranking. Make sure your PayPal account is active and the email entered is correct, as this is how we will transfer your winnings!
                    </div>
                </div>
                
                <div class="avatars-section">
                    <div class="avatars-wrapper">
                        <div class="section-title">Select your avatar</div>
                        <div class="avatars-grid" id="avatars-grid">
                            <!-- Les avatars seront ajoutés dynamiquement ici -->
                        </div>
                        <div class="ios-spacer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Initialize Telegram WebApp with proper error handling
        let tg = null;
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                console.log("📱 Telegram WebApp detected");
                
                // Expand to fill the screen
                if (typeof tg.expand === 'function') {
                    tg.expand();
                    console.log("✅ Telegram WebApp expanded");
                }
                
                // Set background color
                if (typeof tg.setBackgroundColor === 'function') {
                    tg.setBackgroundColor("#0A0A0A");
                }
                
                // Ready event
                if (typeof tg.onEvent === 'function') {
                    tg.onEvent('viewportChanged', function() {
                        console.log("📏 Viewport changed, adjusting layout");
                        resizeCanvas(); // Resize canvas when viewport changes
                    });
                }
            } else {
                console.log("⚠️ Telegram WebApp not available, running in standalone mode");
            }
        } catch (error) {
            console.error("❌ Error initializing Telegram WebApp:", error);
        }
        
        // Function to initialize or retrieve user profile
        function initUserProfile() {
            try {
                console.log("🧑 Initializing user profile...");
                
                // Try to get a device identifier or generate a new one
                let deviceId = getCookie("tidashDeviceId");
                if (!deviceId) {
                    deviceId = generateRandomUserId();
                    setCookie("tidashDeviceId", deviceId, 365); // Store for 1 year
                    console.log(`🆕 Generated new device ID: ${deviceId}`);
                } else {
                    console.log(`🔍 Found existing device ID: ${deviceId}`);
                }
                
                // Get Telegram data if available
                let telegramId = "";
                let telegramUsername = "";
                
                // Check if we're in Telegram WebApp and get user data
                if (window.Telegram && window.Telegram.WebApp) {
                    try {
                        const tg = window.Telegram.WebApp;
                        
                        // Get user data from initDataUnsafe
                        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                            const user = tg.initDataUnsafe.user;
                            telegramId = user.id ? user.id.toString() : "";
                            telegramUsername = user.username || "";
                            console.log(`✅ Got Telegram data - ID: ${telegramId}, Username: ${telegramUsername}`);
                        } else {
                            console.log("⚠️ No user data in Telegram WebApp initDataUnsafe");
                        }
                    } catch (tgError) {
                        console.error("❌ Error getting Telegram user data:", tgError);
                    }
                } else {
                    console.log("📱 Not running in Telegram WebApp environment");
                }
            } catch (error) {
                console.error("❌ Error initializing user profile:", error);
            }
        }
        
        // Function to update user profile display
        function updateUserProfileDisplay() {
            try {
                // Update username display
                document.getElementById('username').textContent = username || '';
                document.getElementById('userId').textContent = userId || '';
                
                // Update avatar
                const avatarImg = document.getElementById('avatarImg');
                if (avatarImg) avatarImg.src = avatarSrc || 'avatars/avatar_default.jpg';
                
                // Update settings display if settings screen is visible
                const settingsUserId = document.getElementById('settings-user-id');
                if (settingsUserId) settingsUserId.textContent = userId || '';
                
                const settingsAvatar = document.getElementById('settings-avatar');
                if (settingsAvatar) settingsAvatar.src = avatarSrc || 'avatars/avatar_default.jpg';
                
                const usernameInput = document.getElementById('username-input');
                if (usernameInput) usernameInput.value = username || '';
                
                const paypalEmailInput = document.getElementById('paypal-email');
                if (paypalEmailInput) paypalEmailInput.value = paypalEmail || '';
                
                console.log("✅ User profile display updated");
            } catch (error) {
                console.error("❌ Error updating user profile display:", error);
            }
        }
        
        // Setup username input with proper binding
        function setupUsernameInput() {
            const usernameInput = document.getElementById('username-input');
            if (usernameInput) {
                // Input event for real-time updates
                usernameInput.addEventListener('input', function(e) {
                    username = e.target.value.trim();
                    // Update display in real-time
                    const usernameDisplay = document.getElementById('username');
                    if (usernameDisplay) usernameDisplay.textContent = username;
                });
                
                // Blur event for saving
                usernameInput.addEventListener('blur', function() {
                    if (username.trim() !== '') {
                        console.log(`✏️ Username updated to: ${username}`);
                    } else {
                        this.value = username = generateRandomUsername();
                        console.log(`⚠️ Empty username, generated new one: ${username}`);
                    }
                    // Always send to server when input loses focus
                    sendUserDataToServer();
                });
            }
        }
        
        // Setup PayPal email input with proper binding
        function setupPaypalEmailInput() {
            const paypalEmailInput = document.getElementById('paypal-email');
            if (paypalEmailInput) {
                // Input event for real-time updates
                paypalEmailInput.addEventListener('input', function(e) {
                    paypalEmail = e.target.value.trim();
                });
                
                // Blur event for saving
                paypalEmailInput.addEventListener('blur', function() {
                    console.log(`✏️ PayPal email updated to: ${paypalEmail}`);
                    // Send to server when input loses focus
                    sendUserDataToServer();
                });
            }
        }
        
        // Initialize UI components
        function initUI() {
            // Setup profile button
            const profileButton = document.getElementById('profile-button');
            if (profileButton) {
                profileButton.addEventListener('click', function() {
                    // Show settings screen
                    const settingsScreen = document.getElementById('settings-screen');
                    if (settingsScreen) settingsScreen.style.display = 'block';
                });
            }
            
            // Setup settings close button
            const closeSettingsBtn = document.getElementById('close-settings');
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', function() {
                    // Hide settings screen
                    const settingsScreen = document.getElementById('settings-screen');
                    if (settingsScreen) settingsScreen.style.display = 'none';
                });
            }
            
            // Setup input fields
            setupUsernameInput();
            setupPaypalEmailInput();
            
            console.log("✅ UI components initialized");
        }
        
        // Function to send user data to server
        function sendUserDataToServer() {
            try {
                console.log("📤 Sending user data to server...");
                
                // Get device ID from cookie
                const deviceId = getCookie("tidashDeviceId") || "";
                
                // Get Telegram data if available
                let telegramId = "";
                let telegramUsername = "";
                
                // Check if we're in Telegram WebApp and get user data
                if (window.Telegram && window.Telegram.WebApp) {
                    try {
                        const tg = window.Telegram.WebApp;
                        
                        // Get user data from initDataUnsafe
                        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                            const user = tg.initDataUnsafe.user;
                            telegramId = user.id ? user.id.toString() : "";
                            telegramUsername = user.username || "";
                        }
                    } catch (tgError) {
                        console.error("❌ Error getting Telegram user data for server update:", tgError);
                    }
                }
                
                // Prepare user data
                const userData = {
                    gameId: userId,
                    gameUsername: username,
                    bestScore: bestScore || 0,
                    seasonScore: seasonScore || 0,
                    avatarSrc: avatarSrc ? (
                        avatarSrc.includes('/avatars/') ? 
                        '/avatars/' + avatarSrc.split('/avatars/').pop() : 
                        avatarSrc
                    ) : '/avatars/avatar_default.jpg',
                    paypalEmail: paypalEmail || '',
                    deviceId: deviceId,
                    musicEnabled: isMusicEnabled || false,
                    telegramId: telegramId,
                    telegramUsername: telegramUsername
                };
                
                console.log("📋 User data to send:", userData);
                
                // Send data to server
                return fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to save user data: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('✅ User data saved successfully:', data);
                    
                    // Update user data from response if available
                    if (data && data.user) {
                        userId = data.user.gameId || userId;
                        bestScore = parseInt(data.user.bestScore || bestScore || 0);
                        
                        // Update UI
                        updateUserProfileDisplay();
                    }
                    
                    return data;
                })
                .catch(error => {
                    console.error('❌ Error saving user data:', error);
                });
            } catch (error) {
                console.error("❌ Error in sendUserDataToServer:", error);
            }
        }
        
        // Helper function to get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // Helper function to set cookie
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Strict";
        }
        
        // Générer un nom d'utilisateur aléatoire
        function generateRandomUsername() {
            const adjectives = [
                "Cosmic", "Stellar", "Quantum", "Neon", "Cyber", 
                "Digital", "Pixel", "Techno", "Hyper", "Mega", 
                "Ultra", "Retro", "Future", "Laser", "Plasma", 
                "Crystal", "Glitch", "Vector", "Synth", "Astro"
            ];
            
            const nouns = [
                "Runner", "Racer", "Dasher", "Pilot", "Navigator", 
                "Explorer", "Voyager", "Jumper", "Drifter", "Surfer", 
                "Rider", "Hunter", "Ninja", "Warrior", "Knight", 
                "Wizard", "Hacker", "Gamer", "Player", "Master"
            ];
            
            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            
            return randomAdjective + randomNoun;
        }
        
        // Générer un ID à 10 chiffres
        function generateRandomUserId() {
            let id = "";
            for (let i = 0; i < 10; i++) {
                id += Math.floor(Math.random() * 10);
            }
            return id;
        }
        
        // Game variables initialization
        let username = "";
        let userId = "";
        let avatarSrc = "avatars/avatar_default.jpg";
        let paypalEmail = "";
        let bestScore = 0;
        let seasonScore = 0;
        let isMusicEnabled = false;
        let gameMode = 'home';
        let gameRunning = false;
        
        // Initialize the game when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🎮 TiDash Game starting...");
            
            try {
                // Initialize canvas dimensions
                resizeCanvas();
                
                // Initialize user profile
                initUserProfile();
                
                // Initialize UI components
                initUI();
                
                // Start game in home mode
                gameMode = 'home';
                gameRunning = true;
                
                console.log("✅ Game initialized successfully");
            } catch (error) {
                console.error("❌ Error during game initialization:", error);
            }
        });
        
        // Function to resize canvas
        function resizeCanvas() {
            try {
                const canvas = document.getElementById('game-canvas');
                if (canvas) {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    console.log(`📏 Canvas resized to ${canvas.width}x${canvas.height}`);
                }
            } catch (error) {
                console.error("❌ Error resizing canvas:", error);
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            // Delay resize to avoid performance issues during resize
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(function() {
                resizeCanvas();
            }, 250);
        });
    </script>
</body>
</html>
